name: Build Pipeline
env:
  PR_NUMBER: ${{ github.event.number || github.event.inputs.prNumber || github.head_ref }}
  ALGOLIA_INDEX: 'asap-hub_CI-${{ env.PR_NUMBER }}'
  ASAP_API_URL: 'https://api-${{ env.PR_NUMBER }}.hub.asap.science'
  ASAP_APP_URL: 'https://${{ env.PR_NUMBER }}.hub.asap.science'
  ASAP_HOSTNAME: 'hub.asap.science'
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_ACM_CERTIFICATE_ARN: ${{ secrets.AWS_ACM_CERTIFICATE_ARN }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  CURRENT_REVISION: ${{ github.sha }}
  LIGHTSTEP_TOKEN: ${{ secrets.LIGHTSTEP_TOKEN }}
  NODE_ENV: 'production'
  NODE_OPTIONS: '--max_old_space_size=4096'
  SENTRY_DSN_API: ${{ secrets.SENTRY_DSN_API }}
  SENTRY_DSN_CALENDAR: ${{ secrets.SENTRY_DSN_CALENDAR }}
  SENTRY_DSN_USER_INVITE: ${{ secrets.SENTRY_DSN_USER_INVITE }}
  SLS_STAGE: '${{ env.PR_NUMBER }}'
  SQUIDEX_APP_NAME: ${{ env.PR_NUMBER }}-${{ github.run_id }}
  SQUIDEX_BASE_URL: ${{ secrets.SQUIDEX_BASE_URL }}
  SQUIDEX_CLIENT_ID: ${{ secrets.SQUIDEX_CLIENT_ID_TEST }}
  SQUIDEX_CLIENT_SECRET: ${{ secrets.SQUIDEX_CLIENT_SECRET_TEST }}
  SQUIDEX_SHARED_SECRET: ${{ secrets.SQUIDEX_SHARED_SECRET_TEST }}

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - master
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
        description: Choose which PR number to destroy
jobs:
  setup:
    uses: ./.github/workflows/setup.yml
    with:
      asap-hostname: $ASAP_HOSTNAME
  test-unit:
    permissions:
      packages: read
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.setup.outputs.integration-image-name }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Cache Jest cache
        uses: actions/cache@v2
        id: jest-cache
        with:
          path: |
            .jest-cache/
          key: jest-cache
      - name: Test
        run: |
          echo $PR_NUMBER
          echo $ASAP_API_URL
