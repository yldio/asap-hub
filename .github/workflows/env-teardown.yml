name: Remove environment
on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
        description: Choose which PR number to destroy
jobs:
  setup:
    uses: ./.github/workflows/setup.yml
  sls_teardown:
    needs: setup
    runs-on: ubuntu-18.04
    container:
      image: ${{ needs.setup.outputs.integration-image-name }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Rebuild dependencies
        run: yarn rebuild
      - name: Teardown SLS
        uses: ./.github/actions/env-teardown-sls
        with:
          prNumber: ${{ needs.setup.outputs.pr-number }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACM_CERTIFICATE_ARN: ${{ secrets.AWS_ACM_CERTIFICATE_ARN }}
          AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SQUIDEX_CLIENT_ID: ${{ secrets.SQUIDEX_CLIENT_ID_TEST }}
          SQUIDEX_CLIENT_SECRET: ${{ secrets.SQUIDEX_CLIENT_SECRET_TEST }}

  delete_algolia_indice:
    needs: setup
    runs-on: ubuntu-18.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: 'us-east-1'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Teardown Algolia indice
        uses: ./.github/actions/env-teardown-algolia-indice
        with:
          prNumber: ${{ needs.setup.outputs.pr-number }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  notify_failure:
    runs-on: ubuntu-18.04
    needs: [sls_teardown, delete_algolia_indice]
    if: failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: ./.github/actions/slack/
        with:
          message: Environment teardown
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          status: failure
