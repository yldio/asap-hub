name: Remove environment
on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
        description: Choose which PR number to destroy
jobs:
  setup:
    uses: ./.github/workflows/setup.yml
  sls_teardown:
    needs: setup
    runs-on: ubuntu-18.04
    container:
      image: ${{ needs.setup.outputs.integration-image-name }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Rebuild dependencies
        run: yarn rebuild
      - name: Teardown
        uses: ./.github/actions/env-teardown
        with:
          prNumber: ${{ needs.setup.outputs.pr-number }}

  delete_algolia_indice:
    needs: setup
    runs-on: ubuntu-18.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: 'us-east-1'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Fetch the Algolia keys
        run: |
          echo "ALGOLIA_APP_ID=$(aws ssm get-parameter --name 'algolia-app-id-dev' --query Parameter.Value --output text)" >> $GITHUB_ENV
          echo "ALGOLIA_API_KEY=$(aws ssm get-parameter --name 'algolia-api-key-ci-dev' --query Parameter.Value --output text)" >> $GITHUB_ENV
      - name: Delete the index
        run: |
          cd apps/crn-server
          export ALGOLIA_INDEX=asap-hub_CI-${{ needs.setup.outputs.pr-number }}
          yarn workspace @asap-hub/crn-server run algolia deleteindicespattern -a $ALGOLIA_APP_ID -k $ALGOLIA_API_KEY -r "^$ALGOLIA_INDEX$" -x false
  notify_failure:
    runs-on: ubuntu-18.04
    needs: [sls_teardown, delete_algolia_indice]
    if: failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: ./.github/actions/slack/
        with:
          message: Environment teardown
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          status: failure
