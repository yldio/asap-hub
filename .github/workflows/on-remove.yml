name: Remove environment
permissions: read-all
on:
  pull_request_target:
    types: [closed]
  workflow_dispatch:
    inputs:
      prNumber:
        required: true
        type: string
        description: Choose which PR number to destroy
jobs:
  sls-teardown:
    if: ${{ github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub' }}
    runs-on: ubuntu-18.04
    container:
      image: ghcr.io/yldio/asap-hub/node-python-sq:1de8c60b2214fbca2e0959aa7f473c55bbc2e014
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      NODE_ENV: 'production'
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      SQUIDEX_CLIENT_SECRET: ${{ secrets.SQUIDEX_CLIENT_SECRET_TEST }}
    steps:
      - name: Echo
        run: echo 'sls teardown'

  delete-algolia-indice:
    if: ${{ github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub' }}
    runs-on: ubuntu-18.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - name: Echo
        run: echo 'algolia teardown'

  notify_failure:
    runs-on: ubuntu-18.04
    needs: [sls-teardown, delete-algolia-indice]
    steps:
      - name: Echo
        if: ${{ failure() && (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
        run: |
          echo ${{  (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
          echo "build failed"

  notify_failure2:
    runs-on: ubuntu-18.04
    needs: [sls-teardown, delete-algolia-indice]
    steps:
      - name: Echo
        if: failure() && ${{  (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
        run: |
          echo ${{  (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
          echo "build failed 2"
  notify_success:
    runs-on: ubuntu-18.04
    needs: [sls-teardown, delete-algolia-indice]
    steps:
      - name: Echo
        if: success() && ${{ (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
        run: |
          echo ${{  (github.event.inputs.prNumber || github.event.pull_request.head.repo.full_name == 'yldio/asap-hub') }}
          echo "build success"
