image: node:12

stages:
  - build-packages
  - build-apps
  - build-native
  - test
  - deploy

# stage test

check:packages:
  script:
    - yarn install --immutable --immutable-cache
  needs: []
  stage: test

check:constraints:
  script:
    - yarn constraints
  needs: []
  stage: test

check:format:
  script:
    - yarn run lint:format
  needs: []
  stage: test

test:
  script:
    - yarn run test --coverage
  artifacts:
    paths:
      - coverage
  needs:
    - build:babel
  stage: test

# stage build-packages

build:babel:
  script:
    - yarn run build:babel
  artifacts:
    untracked: true
    paths:
      - packages/
  needs: []
  stage: build-packages

build:typecheck:
  script:
    - yarn run build:typecheck
  artifacts:
    untracked: true
    paths:
      - packages/
  needs: []
  stage: build-packages

# stage build-apps

build:frontend:
  script:
    - yarn build:frontend
  artifacts:
    untracked: true
    paths:
      - apps/frontend/
  needs:
    - build:babel
    - build:typecheck
  stage: build-apps

# stage build-native

build:native:
  script:
    - yarn rebuild
  artifacts:
    untracked: true
    paths:
      - .yarn/
  needs: []
  stage: build-native

# stage deploy

deploy:sls:branch:
  artifacts:
    reports:
      dotenv: deploy.env
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://$APP_URL
    on_stop: deploy:sls:branch_remove
  script:
    - yarn pnpify serverless deploy --verbose
    - echo "APP_URL=$(yarn pnpify serverless info --verbose | grep -w "CloudFrontDistributionDomain" | cut -d ' ' -f2)" >> deploy.env
  only:
    - external_pull_requests
  needs:
    - build:frontend
    - build:native
  stage: deploy
  variables:
    SLS_STAGE: $CI_COMMIT_REF_SLUG

deploy:sls:branch_remove:
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - yarn pnpify serverless remove --verbose
  only:
    - external_pull_requests
  needs:
    - build:native
  stage: deploy
  variables:
    SLS_STAGE: $CI_COMMIT_REF_SLUG
  when: manual
