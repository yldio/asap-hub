import * as XLSX from 'xlsx';
import { getGraphQLClient as getContentfulGraphQLClient } from '@asap-hub/contentful';
import { FETCH_TAGS_WITH_COUNTS } from '@asap-hub/contentful/src/crn/queries';
import type { FetchTagsWithCountsQuery } from '@asap-hub/contentful/src/crn/autogenerated-gql/graphql';
import {
  contentfulAccessToken,
  contentfulEnvId,
  contentfulSpaceId,
} from '../src/config';

const PAGE_SIZE = 1000;

type TagUtilisation = {
  tagId: string;
  tagName: string;
  category?: string;
  types?: string[];
  frequency: {
    user: number;
    event: number;
    team: number;
    'working-group': number;
    'interest-group': number;
    project: number;
    news: number;
    'research-output': number;
    tutorial: number;
  };
  totalCount: number;
};

// Extract the tag item type from the auto-generated query type
type TagItem = NonNullable<
  NonNullable<
    NonNullable<FetchTagsWithCountsQuery['researchTagsCollection']>['items']
  >[number]
>;

const fetchAllTagsWithCounts = async (
  graphQLClient: ReturnType<typeof getContentfulGraphQLClient>,
) => {
  const allTags: Array<{
    id: string;
    name: string;
    category?: string;
    types?: string[];
    counts: {
      user: number;
      event: number;
      team: number;
      'working-group': number;
      'interest-group': number;
      project: number;
      news: number;
      'research-output': number;
      tutorial: number;
    };
  }> = [];

  let skip = 0;
  let hasMore = true;

  while (hasMore) {
    const result = await graphQLClient.request<FetchTagsWithCountsQuery>(
      FETCH_TAGS_WITH_COUNTS,
      {
        limit: PAGE_SIZE,
        skip,
      },
    );

    const collection = result.researchTagsCollection;
    if (!collection) {
      break;
    }

    const mappedItems = collection.items.flatMap((item: TagItem | null) => {
      if (!item || !item.linkedFrom || !item.name) {
        return [];
      }

      const linkedFrom = item.linkedFrom;
      const name = item.name;
      const types: string[] | undefined = item.types
        ? (item.types.filter((t) => t !== null) as string[])
        : undefined;
      return [
        {
          id: item.sys.id,
          name,
          category: item.category || undefined,
          types,
          counts: {
            user: linkedFrom.usersCollection?.total ?? 0,
            event: linkedFrom.eventsCollection?.total ?? 0,
            team: linkedFrom.teamsCollection?.total ?? 0,
            'working-group': linkedFrom.workingGroupsCollection?.total ?? 0,
            'interest-group': linkedFrom.interestGroupsCollection?.total ?? 0,
            project: linkedFrom.projectsCollection?.total ?? 0,
            news: linkedFrom.newsCollection?.total ?? 0,
            'research-output': linkedFrom.researchOutputsCollection?.total ?? 0,
            tutorial: linkedFrom.tutorialsCollection?.total ?? 0,
          },
        },
      ];
    });

    allTags.push(...mappedItems);

    skip += PAGE_SIZE;
    hasMore = skip < collection.total;
  }

  return allTags;
};

export const exportTagsUtilisation = async (
  filename?: string,
): Promise<void> => {
  console.log('Starting tags utilisation export...');

  const graphQLClient = getContentfulGraphQLClient({
    space: contentfulSpaceId,
    accessToken: contentfulAccessToken,
    environment: contentfulEnvId,
  });

  // Fetch all tags with counts from linked collections
  console.log('Fetching all tags with entity counts...');
  const tagsWithCounts = await fetchAllTagsWithCounts(graphQLClient);
  console.log(`Found ${tagsWithCounts.length} tags`);

  // Build tag utilisation data
  console.log('Building tag utilisation data...');
  const tagUtilisation: TagUtilisation[] = tagsWithCounts.map((tag) => {
    const totalCount =
      tag.counts.user +
      tag.counts.event +
      tag.counts.team +
      tag.counts['working-group'] +
      tag.counts['interest-group'] +
      tag.counts.project +
      tag.counts.news +
      tag.counts['research-output'] +
      tag.counts.tutorial;

    return {
      tagId: tag.id,
      tagName: tag.name,
      category: tag.category,
      types: tag.types,
      frequency: {
        user: tag.counts.user,
        event: tag.counts.event,
        team: tag.counts.team,
        'working-group': tag.counts['working-group'],
        'interest-group': tag.counts['interest-group'],
        project: tag.counts.project,
        news: tag.counts.news,
        'research-output': tag.counts['research-output'],
        tutorial: tag.counts.tutorial,
      },
      totalCount,
    };
  });

  // Sort by total count descending
  tagUtilisation.sort((a, b) => b.totalCount - a.totalCount);

  // Prepare data for Excel export
  const excelData = tagUtilisation.map((tag) => ({
    'Tag ID': tag.tagId,
    'Tag Name': tag.tagName,
    Category: tag.category || '',
    Types: tag.types ? tag.types.join('; ') : '',
    'User Count': tag.frequency.user,
    'Event Count': tag.frequency.event,
    'Team Count': tag.frequency.team,
    'Working Group Count': tag.frequency['working-group'],
    'Interest Group Count': tag.frequency['interest-group'],
    'Project Count': tag.frequency.project,
    'News Count': tag.frequency.news,
    'Research Output Count': tag.frequency['research-output'],
    'Tutorial Count': tag.frequency.tutorial,
    'Total Count': tag.totalCount,
  }));

  // Create workbook and worksheet
  const workbook = XLSX.utils.book_new();
  const worksheet = XLSX.utils.json_to_sheet(excelData);

  // Set column widths
  worksheet['!cols'] = [
    { wch: 40 }, // Tag ID
    { wch: 30 }, // Tag Name
    { wch: 15 }, // Category
    { wch: 30 }, // Types
    { wch: 12 }, // User Count
    { wch: 12 }, // Event Count
    { wch: 12 }, // Team Count
    { wch: 20 }, // Working Group Count
    { wch: 20 }, // Interest Group Count
    { wch: 14 }, // Project Count
    { wch: 12 }, // News Count
    { wch: 22 }, // Research Output Count
    { wch: 14 }, // Tutorial Count
    { wch: 12 }, // Total Count
  ];

  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Tags Utilisation');

  // Write Excel file
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = now.getFullYear();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  const dateString = `${day}-${month}-${year}-${hours}${minutes}${seconds}`;

  const excelFilename = filename
    ? `${filename}.xlsx`
    : `tags-utilisation-${dateString}.xlsx`;
  XLSX.writeFile(workbook, excelFilename);
  console.log(`Exported Excel to ${excelFilename}`);

  console.log(
    `Finished exporting tags utilisation for ${tagUtilisation.length} tags`,
  );
};
