import Boom from '@hapi/boom';
import {
  ListExternalAuthorResponse,
  ExternalAuthorResponse,
} from '@asap-hub/model';
import {
  SquidexGraphqlClient,
  SquidexRestClient,
  SquidexRest,
  RestExternalAuthor,
  ExternalAuthor,
} from '@asap-hub/squidex';
import { parseGraphQLExternalAuthor } from '../entities';
import {
  FetchExternalAuthorQuery,
  FetchExternalAuthorQueryVariables,
  FetchExternalAuthorsQuery,
  FetchExternalAuthorsQueryVariables,
} from '../autogenerated-gql/graphql';
import {
  FETCH_EXTERNAL_AUTHOR,
  FETCH_EXTERNAL_AUTHORS,
} from '../queries/external-authors.queries';
import { FetchOptions } from '../utils/types';
import { parseToSquidex } from '../utils/squidex';

export interface ExternalAuthorsController {
  fetch(options: FetchOptions): Promise<ListExternalAuthorResponse>;
  fetchById(id: string): Promise<ExternalAuthorResponse>;
  create(
    externalAuthor: Partial<ExternalAuthor>,
  ): Promise<Partial<ExternalAuthorResponse>>;
}

export default class ExternalAuthors implements ExternalAuthorsController {
  squidexGraphlClient: SquidexGraphqlClient;
  squidexRestClient: SquidexRestClient<RestExternalAuthor>;

  constructor(squidexGraphlClient: SquidexGraphqlClient) {
    this.squidexGraphlClient = squidexGraphlClient;
    this.squidexRestClient = new SquidexRest('external-authors');
  }

  async fetch(options: FetchOptions): Promise<ListExternalAuthorResponse> {
    const { take = 8, skip = 0 } = options;

    const { queryExternalAuthorsContentsWithTotal } =
      await this.squidexGraphlClient.request<
        FetchExternalAuthorsQuery,
        FetchExternalAuthorsQueryVariables
      >(FETCH_EXTERNAL_AUTHORS, { top: take, skip });

    if (queryExternalAuthorsContentsWithTotal === null) {
      return {
        total: 0,
        items: [],
      };
    }

    const { total, items } = queryExternalAuthorsContentsWithTotal;

    if (items === null) {
      return {
        total: 0,
        items: [],
      };
    }

    return {
      total,
      items: items.map(parseGraphQLExternalAuthor),
    };
  }

  async fetchById(id: string): Promise<ExternalAuthorResponse> {
    const { findExternalAuthorsContent } =
      await this.squidexGraphlClient.request<
        FetchExternalAuthorQuery,
        FetchExternalAuthorQueryVariables
      >(FETCH_EXTERNAL_AUTHOR, { id });
    if (!findExternalAuthorsContent) {
      throw Boom.notFound();
    }

    return parseGraphQLExternalAuthor(findExternalAuthorsContent);
  }

  async create(
    externalAuthor: Partial<ExternalAuthor>,
  ): Promise<Partial<ExternalAuthorResponse>> {
    return this.squidexRestClient.create(
      parseToSquidex(externalAuthor) as RestExternalAuthor['data'],
    );
  }
}
