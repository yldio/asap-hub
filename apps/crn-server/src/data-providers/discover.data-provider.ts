import { DiscoverDataObject } from '@asap-hub/model';
import { SquidexGraphqlClient } from '@asap-hub/squidex';
import { FetchDiscoverQuery } from '../autogenerated-gql/graphql';
import { parseGraphQLPage, parseGraphQLTutorials } from './transformers';
import { FETCH_DISCOVER } from '../queries/discover.queries';
import { DiscoverDataProvider } from './types';
import { parseGraphQLUser } from './user.data-provider';

export class DiscoverSquidexDataProvider implements DiscoverDataProvider {
  constructor(private squidexGraphqlClient: SquidexGraphqlClient) {}
  async fetch(): Promise<DiscoverDataObject> {
    const { queryDiscoverContents } =
      await this.squidexGraphqlClient.request<FetchDiscoverQuery>(
        FETCH_DISCOVER,
      );

    if (
      !queryDiscoverContents ||
      queryDiscoverContents.length === 0 ||
      !queryDiscoverContents[0]
    ) {
      return {
        aboutUs: '',
        training: [],
        members: [],
        scientificAdvisoryBoard: [],
        pages: [],
      };
    }

    const [{ flatData }] = queryDiscoverContents;
    return {
      aboutUs: flatData.aboutUs || '',
      training: flatData.training?.map(parseGraphQLTutorials) ?? [],
      members: flatData.members?.map(parseGraphQLUser) ?? [],
      membersTeamId: flatData.membersTeam?.[0]?.id,
      scientificAdvisoryBoard:
        flatData.scientificAdvisoryBoard?.map(parseGraphQLUser) ?? [],
      pages: flatData.pages?.map(parseGraphQLPage) ?? [],
    };
  }
}
