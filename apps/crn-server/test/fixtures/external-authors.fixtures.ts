import {
  ContentfulWebhookPayload,
  FetchExternalAuthorsQuery as ContentfulFetchExternalAuthorsQuery,
} from '@asap-hub/contentful';
import {
  ExternalAuthorCreateDataObject,
  ExternalAuthorDataObject,
  ExternalAuthorResponse,
  ListExternalAuthorDataObject,
  ListExternalAuthorResponse,
  WebhookDetail,
} from '@asap-hub/model';
import { SquidexWebhookPayload, ExternalAuthor } from '@asap-hub/squidex';
import { EventBridgeEvent } from 'aws-lambda';
import {
  FetchExternalAuthorsQuery,
  FetchExternalAuthorQuery,
} from '../../src/autogenerated-gql/graphql';

import { ExternalAuthorEvent } from '../../src/handlers/event-bus';
import { createEventBridgeEventMock } from '../helpers/events';

export const getContentfulGraphqlExternalAuthor = (): NonNullable<
  NonNullable<
    ContentfulFetchExternalAuthorsQuery['externalAuthorsCollection']
  >['items'][number]
> => ({
  sys: {
    id: 'external-author-id-1',
    firstPublishedAt: '2021-11-23T20:45:22Z',
    publishedAt: '2021-11-26T15:33:18Z',
    publishedVersion: 45,
  },
  name: 'external author one',
  orcid: 'orcid-1',
});

export const getContentfulGraphqlExternalAuthorsResponse =
  (): ContentfulFetchExternalAuthorsQuery => ({
    externalAuthorsCollection: {
      total: 1,
      items: [getContentfulGraphqlExternalAuthor()],
    },
  });

export const getSquidexExternalAuthorGraphqlResponse =
  (): FetchExternalAuthorQuery => ({
    findExternalAuthorsContent: getGraphQLExternalAuthor(),
  });
export const getSquidexExternalAuthorsGraphqlResponse =
  (): FetchExternalAuthorsQuery =>
    generateGraphqlFetchExternalAuthorsResponse([getGraphQLExternalAuthor()]);

const generateGraphqlFetchExternalAuthorsResponse = (
  items: NonNullable<FetchExternalAuthorQuery['findExternalAuthorsContent']>[],
): FetchExternalAuthorsQuery => ({
  queryExternalAuthorsContentsWithTotal: {
    total: items.length,
    items,
  },
});

export const getGraphqlResponseFetchExternalAuthors =
  (): FetchExternalAuthorsQuery =>
    generateGraphqlFetchExternalAuthorsResponse([getGraphQLExternalAuthor()]);

export const getGraphQLExternalAuthor = (
  externalAuthor: Partial<
    NonNullable<FetchExternalAuthorQuery['findExternalAuthorsContent']>
  > = {},
): NonNullable<FetchExternalAuthorQuery['findExternalAuthorsContent']> => ({
  id: 'external-author-id-1',
  lastModified: '2021-11-26T15:33:18Z',
  version: 45,
  created: '2021-11-23T20:45:22Z',
  ...externalAuthor,
  flatData: {
    name: 'external author one',
    orcid: 'orcid-1',
  },
});

export const getExternalAuthorDataObject = (): ExternalAuthorDataObject => ({
  id: 'external-author-id-1',
  displayName: 'external author one',
  orcid: 'orcid-1',
});

export const getListExternalAuthorDataObject =
  (): ListExternalAuthorDataObject => ({
    total: 2,
    items: [
      getExternalAuthorResponse(),
      {
        id: 'external-author-id-2',
        displayName: 'external author two',
        orcid: 'orcid-2',
      },
    ],
  });

export const getExternalAuthorResponse = (): ExternalAuthorResponse =>
  getExternalAuthorDataObject();

export const getListExternalAuthorResponse = (): ListExternalAuthorResponse =>
  getListExternalAuthorDataObject();

export const externalAuthorPublishedEvent: SquidexWebhookPayload<ExternalAuthor> =
  {
    type: 'ExternalAuthorsPublished',
    timestamp: '2021-02-15T13:11:25Z',
    payload: {
      $type: 'EnrichedContentEvent',
      type: 'Published',
      id: 'externalAuthorId',
      created: '2020-07-31T15:52:33Z',
      lastModified: '2020-07-31T15:52:33Z',
      version: 42,
      data: {
        name: { iv: 'External Author' },
        orcid: { iv: 'orcid-1' },
      },
    },
  };

export const getExternalAuthorSquidexWebhookDetail = (
  id: string,
  type: ExternalAuthorEvent,
): WebhookDetail<
  SquidexWebhookPayload<ExternalAuthor, ExternalAuthorEvent>
> => ({
  resourceId: id,
  type,
  timestamp: '2021-02-15T13:11:25Z',
  payload: {
    $type: 'EnrichedContentEvent',
    type: 'Updated',
    id,
    created: '2021-02-15T13:11:25Z',
    lastModified: '2021-02-15T13:11:25Z',
    version: 1,
    data: {
      name: { iv: 'External Author' },
      orcid: { iv: 'orcid-1' },
    },
  },
});

export const getExternalAuthorContentfulWebhookDetail = (
  id: string,
): WebhookDetail<ContentfulWebhookPayload<'externalAuthors'>> => ({
  resourceId: id,
  metadata: {
    tags: [],
  },
  sys: {
    type: 'Entry',
    id: '2i3zL0KG5pjxnNQpDOqf01',
    space: {
      sys: {
        type: 'Link',
        linkType: 'Space',
        id: '5v6w5j61tndm',
      },
    },
    environment: {
      sys: {
        id: 'crn-2802',
        type: 'Link',
        linkType: 'Environment',
      },
    },
    contentType: {
      sys: {
        type: 'Link',
        linkType: 'ContentType',
        id: 'externalAuthors',
      },
    },
    createdBy: {
      sys: {
        type: 'Link',
        linkType: 'User',
        id: '1W39zODWXRZZPH4On1MQoS',
      },
    },
    updatedBy: {
      sys: {
        type: 'Link',
        linkType: 'User',
        id: '1W39zODWXRZZPH4On1MQoS',
      },
    },
    revision: 1,
    createdAt: '2023-03-22T15:40:48.930Z',
    updatedAt: '2023-03-22T15:40:48.930Z',
  },
  fields: {
    displayName: {
      'en-US': 'team 1',
    },
    applicationNumber: {
      'en-US': 'ASAP',
    },
    projectTitle: {
      'en-US': 'Test title',
    },
  },
});

export const getExternalAuthorSquidexEvent = (
  id: string,
  eventType: ExternalAuthorEvent,
): EventBridgeEvent<
  ExternalAuthorEvent,
  WebhookDetail<SquidexWebhookPayload<ExternalAuthor, ExternalAuthorEvent>>
> =>
  createEventBridgeEventMock(
    getExternalAuthorSquidexWebhookDetail(id, eventType),
    eventType,
    id,
  );

export const getExternalAuthorContentfulEvent = (
  id: string,
  eventType: ExternalAuthorEvent,
): EventBridgeEvent<
  ExternalAuthorEvent,
  WebhookDetail<ContentfulWebhookPayload<'externalAuthors'>>
> =>
  createEventBridgeEventMock(
    getExternalAuthorContentfulWebhookDetail(id),
    eventType,
    id,
  );

export const getExternalAuthorCreateDataObject =
  (): ExternalAuthorCreateDataObject => ({
    name: 'External Author',
    orcid: 'orcid-1',
  });
