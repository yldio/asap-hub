import { gp2 as gp2Model } from '@asap-hub/model';
import {
  gp2 as gp2Squidex,
  parseDate,
  parseToSquidex,
  SquidexGraphqlClient,
  SquidexRestClient,
} from '@asap-hub/squidex';
import {
  FetchUserQuery,
  FetchUserQueryVariables,
  FetchUsersQuery,
  FetchUsersQueryVariables,
  UsersDataDegreeEnum,
  UsersDataRegionEnum,
  UsersDataRoleEnum,
} from '../autogenerated-gql/graphql';

import { FETCH_USER, FETCH_USERS } from '../queries/users.queries';
import { reverseMap } from '../utils/reverse-map';
import { roleMap as projectRoleMap } from './project.data-provider';
import { roleMap as workingGroupRoleMap } from './working-group.data-provider';

export interface UserDataProvider {
  fetchById(id: string): Promise<gp2Model.UserDataObject | null>;
  update(id: string, update: gp2Model.UserUpdateDataObject): Promise<void>;
  create(update: gp2Model.UserCreateDataObject): Promise<string>;
  fetch(
    options: gp2Model.FetchUsersOptions,
  ): Promise<gp2Model.ListUserDataObject>;
}

export class UserSquidexDataProvider implements UserDataProvider {
  constructor(
    private squidexGraphqlClient: SquidexGraphqlClient,
    private userSquidexRestClient: SquidexRestClient<
      gp2Squidex.RestUser,
      gp2Squidex.InputUser
    >,
  ) {}

  async fetchById(id: string): Promise<gp2Model.UserDataObject | null> {
    const { findUsersContent } = await this.queryFetchByIdData(id);
    if (!findUsersContent) {
      return null;
    }
    return parseGraphQLUserToDataObject(findUsersContent);
  }

  async update(
    id: string,
    userToUpdate: gp2Model.UserUpdateDataObject,
  ): Promise<void> {
    const cleanedUser = getUserSquidexData(userToUpdate);

    await this.userSquidexRestClient.patch(id, cleanedUser);
  }

  async create(userToCreate: gp2Model.UserCreateDataObject): Promise<string> {
    const cleanedUser = getUserSquidexData(userToCreate);

    const { id } = await this.userSquidexRestClient.create({
      ...cleanedUser,
      avatar: { iv: [] },
      connections: { iv: [] },
    });

    return id;
  }
  async fetch(
    options: gp2Model.FetchUsersOptions,
  ): Promise<gp2Model.ListUserDataObject> {
    const queryFilter = generateFetchQueryFilter(options);
    const { take = 8, skip = 0 } = options;
    return this.queryForUsers(queryFilter, take, skip);
  }

  private async queryForUsers(filter: string, top: number, skip: number) {
    const { queryUsersContentsWithTotal } = await this.queryFetchData(
      filter,
      top,
      skip,
    );

    const { total = 0, items = [] } = queryUsersContentsWithTotal || {};

    return {
      total: items ? total : 0,
      items: (items || []).map(parseGraphQLUserToDataObject),
    };
  }
  private async queryFetchData(filter: string, top: number, skip: number) {
    return this.squidexGraphqlClient.request<
      FetchUsersQuery,
      FetchUsersQueryVariables
    >(FETCH_USERS, { filter, top, skip });
  }
  private async queryFetchByIdData(id: string) {
    return this.squidexGraphqlClient.request<
      FetchUserQuery,
      FetchUserQueryVariables
    >(FETCH_USER, { id });
  }
}

type UserCreateDataObjectEnumFields = Pick<
  gp2Model.UserCreateDataObject,
  'degrees' | 'region' | 'role'
>;
type UserCreateInputEnumFields = {
  degree?: `${UsersDataDegreeEnum}`[];
  region: UsersDataRegionEnum;
  role: UsersDataRoleEnum;
};
type UserUpdateDataObjectEnumFields = Pick<
  gp2Model.UserUpdateDataObject,
  'degrees' | 'region' | 'role'
>;
type UserUpdateInputEnumFields = Partial<UserCreateInputEnumFields>;
const mapUserFields = (
  input: UserCreateDataObjectEnumFields | UserUpdateDataObjectEnumFields,
): UserCreateInputEnumFields | UserUpdateInputEnumFields => {
  const mappedDegrees = input.degrees?.map((degree) => {
    if (degree === 'MD, PhD') {
      return UsersDataDegreeEnum.MdPhD;
    }

    return degree;
  });

  return {
    ...(input.region && { region: reverseRegionMap[input.region] }),
    ...(input.role && { role: reverseRoleMap[input.role] }),
    ...(input.degrees && { degree: mappedDegrees }),
  };
};

function getUserSquidexData(
  input: gp2Model.UserCreateDataObject,
): Omit<gp2Squidex.InputUser['data'], 'connections' | 'avatar'>;
function getUserSquidexData(
  input: gp2Model.UserUpdateDataObject,
): Partial<Omit<gp2Squidex.InputUser['data'], 'connections' | 'avatar'>>;
function getUserSquidexData(
  input: gp2Model.UserUpdateDataObject | gp2Model.UserCreateDataObject,
):
  | Omit<gp2Squidex.InputUser['data'], 'connections' | 'avatar'>
  | Partial<Omit<gp2Squidex.InputUser['data'], 'connections' | 'avatar'>> {
  const { region, role, degrees, ...userInput } = input;
  const fieldMappedUser = mapUserFields({ region, role, degrees });
  return parseToSquidex({ ...userInput, ...fieldMappedUser });
}

const generateFetchQueryFilter = ({ filter }: gp2Model.FetchUsersOptions) => {
  const { region, code } = filter || {};
  const filterRegions = region
    ?.map((r) => `data/region/iv eq '${reverseRegionMap[r]}'`)
    .join(' or ');

  const filterCode = code && `data/connections/iv/code eq '${code}'`;

  return [filterRegions, filterCode].filter(Boolean).join(' and ').trim();
};

export const parseGraphQLUserToDataObject = ({
  id,
  created,
  referencingProjectsContents: projectItems,
  referencingWorkingGroupsContents: workingGroupItems,
  flatData: item,
}: NonNullable<
  FetchUserQuery['findUsersContent']
>): gp2Model.UserDataObject => {
  if (!item.region) {
    throw new Error(`Region not defined: ${item.region}`);
  }
  if (!item.role) {
    throw new Error(`Role not defined: ${item.role}`);
  }
  const createdDate = parseDate(created).toISOString();

  const degrees: gp2Model.UserDegree[] | undefined =
    item.degree?.map<gp2Model.UserDegree>((degree) => {
      if (degree === 'MD_PhD') {
        return 'MD, PhD';
      }

      return degree;
    });

  const positions =
    item.positions?.map(({ role, department, institution }) => {
      if (!(role && department && institution)) {
        throw new Error('Position not defined');
      }
      return {
        role,
        department,
        institution,
      };
    }) || [];

  const projects =
    projectItems?.map(({ id: projectId, flatData: project }) => {
      if (!project.status) {
        throw new TypeError('status is unknown');
      }
      return {
        id: projectId,
        status: project.status,
        title: project.title || '',
        members:
          project.members?.map((member) => {
            const user = member.user && member.user[0];

            if (!(member.role && user)) {
              throw new Error('Invalid project members');
            }
            return { role: projectRoleMap[member.role], userId: user.id };
          }) || [],
      };
    }) || [];

  const workingGroups =
    workingGroupItems?.map(({ id: workingGroupId, flatData }) => ({
      id: workingGroupId,
      title: flatData.title || '',
      members:
        flatData.members?.map((member) => {
          const user = member.user && member.user[0];

          if (!(member.role && user)) {
            throw new Error('Invalid project members');
          }
          return { role: workingGroupRoleMap[member.role], userId: user.id };
        }) || [],
    })) || [];

  return {
    id,
    createdDate,
    firstName: item.firstName || '',
    lastName: item.lastName || '',
    degrees,
    email: item.email || '',
    region: regionMap[item.region],
    role: roleMap[item.role],
    country: item.country || '',
    city: item.city || undefined,
    positions,
    onboarded: item.onboarded || false,
    projects,
    workingGroups,
  };
};

const regionMap: Record<UsersDataRegionEnum, gp2Model.UserRegion> = {
  [UsersDataRegionEnum.Africa]: 'Africa',
  [UsersDataRegionEnum.Asia]: 'Asia',
  [UsersDataRegionEnum.AustraliaAustraliasia]: 'Australia/Australiasia',
  [UsersDataRegionEnum.Europe]: 'Europe',
  [UsersDataRegionEnum.LatinAmerica]: 'Latin America',
  [UsersDataRegionEnum.NorthAmerica]: 'North America',
  [UsersDataRegionEnum.SouthAmerica]: 'South America',
} as const;
const roleMap: Record<UsersDataRoleEnum, gp2Model.UserRole> = {
  [UsersDataRoleEnum.Administrator]: 'Administrator',
  [UsersDataRoleEnum.NetworkCollaborator]: 'Network Collaborator',
  [UsersDataRoleEnum.NetworkInvestigator]: 'Network Investigator',
  [UsersDataRoleEnum.Trainee]: 'Trainee',
  [UsersDataRoleEnum.WorkingGroupParticipant]: 'Working Group Participant',
} as const;
const reverseRegionMap = reverseMap(regionMap);
const reverseRoleMap = reverseMap(roleMap);
