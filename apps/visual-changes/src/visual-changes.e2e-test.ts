/* eslint-disable no-param-reassign */
/* eslint-disable no-console */

import { getAccessTokenFactory, SquidexGraphql } from '@asap-hub/squidex';
import puppeteer, { Page } from 'puppeteer';
import fs from 'fs';
import pixelmatch from 'pixelmatch';
import { PNG, PNGWithMetadata } from 'pngjs';
import {
  FetchResearchOutputIdsQuery,
  FetchResearchOutputIdsQueryVariables,
} from './autogenerated-gql/graphql';
import { researchOutputIdsQuery } from './visual-changes.queries';

const {
  PR_URL,
  CMS_MIGRATION_USER_EMAIL,
  CMS_MIGRATION_USER_PASSWORD,
  CRN_SQUIDEX_CLIENT_ID,
  CRN_SQUIDEX_CLIENT_SECRET,
  SQUIDEX_BASE_URL,
} = process.env;

const PROD_URL = 'https://hub.asap.science';

const takeScreenshot = async (page: Page, filePath: string) => {
  await page.screenshot({ path: filePath, fullPage: true });
};

const resizeIfNeeded = (
  img: PNGWithMetadata,
  maxHeight: number,
  maxWidth: number,
) => {
  if (img.height === maxHeight && img.width === maxWidth) return;

  const imageCopy = Buffer.alloc(maxHeight * maxWidth * 4);
  img.data.copy(imageCopy);

  img.height = maxHeight;
  img.width = maxWidth;
  img.data = imageCopy;
};

const compareImages = async (
  imagePath1: string,
  imagePath2: string,
  diffPath: string,
) => {
  const img1 = PNG.sync.read(fs.readFileSync(imagePath1));
  const img2 = PNG.sync.read(fs.readFileSync(imagePath2));

  const maxHeight = img1.height > img2.height ? img1.height : img2.height;
  const maxWidth = img1.width > img2.width ? img1.width : img2.width;

  resizeIfNeeded(img1, maxHeight, maxWidth);
  resizeIfNeeded(img2, maxHeight, maxWidth);

  const diff = new PNG({ width: maxWidth, height: maxHeight });

  const numDiffPixels = pixelmatch(
    img1.data,
    img2.data,
    diff.data,
    maxWidth,
    maxHeight,
    { threshold: 0.1 },
  );

  fs.writeFileSync(diffPath, PNG.sync.write(diff));

  return numDiffPixels;
};

const login = async (page: Page) => {
  const signInButtonHome = 'button[type="submit"]';
  await page.waitForSelector(signInButtonHome);
  await page.click(signInButtonHome);

  await page.waitForNavigation({ waitUntil: 'networkidle0' });

  const emailInputSelector = 'input[type="email"]';
  await page.waitForSelector(emailInputSelector);
  await page.type(emailInputSelector, CMS_MIGRATION_USER_EMAIL!);

  const passwordInputSelector = 'input[type="password"]';
  await page.waitForSelector(passwordInputSelector);
  await page.type(passwordInputSelector, CMS_MIGRATION_USER_PASSWORD!);

  const signInButtonLoginPage = 'button[type="submit"]';
  await page.waitForSelector(signInButtonLoginPage);
  await page.click(signInButtonLoginPage);

  await page.waitForNavigation({ waitUntil: 'networkidle0' });

  await new Promise((r) => setTimeout(r, 5000));
};

(async () => {
  const getAuthToken = getAccessTokenFactory({
    clientId: CRN_SQUIDEX_CLIENT_ID!,
    clientSecret: CRN_SQUIDEX_CLIENT_SECRET!,
    baseUrl: SQUIDEX_BASE_URL!,
  });

  const squidexGraphqlClient = new SquidexGraphql(getAuthToken, {
    appName: 'asap-hub',
    baseUrl: SQUIDEX_BASE_URL!,
  });

  const { queryResearchOutputsContentsWithTotal } =
    await squidexGraphqlClient.request<
      FetchResearchOutputIdsQuery,
      FetchResearchOutputIdsQueryVariables
    >(researchOutputIdsQuery);

  console.log(
    'Total research outputs:',
    queryResearchOutputsContentsWithTotal?.total,
  );

  const researchOutputIds = (
    queryResearchOutputsContentsWithTotal?.items || []
  ).map((item) => item.id);

  fs.mkdir('screenshots', (err) => {
    if (err) {
      console.error(err);
    }
  });

  const nonMatchingResearchOutputIds: string[] = [];
  try {
    const browser = await puppeteer.launch({
      headless: true,
      // https://github.com/puppeteer/puppeteer/issues/3698
      args: ['--no-sandbox'],
      ignoreDefaultArgs: ['--disable-extensions'],
    });
    const page = await browser.newPage();

    for (let i = 0; i < researchOutputIds.length; i += 1) {
      const researchOutputId = researchOutputIds[i];
      console.log(`Analyzing research Output: ${researchOutputId}...`);

      const prEnvScreenshotFilename = `screenshots/${researchOutputId}_pr.png`;
      const prodScreenshotFilename = `screenshots/${researchOutputId}_prod.png`;
      const diffScreenshotFilename = `screenshots/${researchOutputId}_diff.png`;

      await page.goto(`${PR_URL}/shared-research/${researchOutputId}`, {
        waitUntil: 'networkidle0',
      });
      if (i === 0) {
        await login(page);
      }
      await takeScreenshot(page, prEnvScreenshotFilename);

      await page.goto(`${PROD_URL}/shared-research/${researchOutputId}`, {
        waitUntil: 'networkidle0',
      });
      if (i === 0) {
        await login(page);
      }
      await takeScreenshot(page, prodScreenshotFilename);

      const numDiffPixels = await compareImages(
        prEnvScreenshotFilename,
        prodScreenshotFilename,
        diffScreenshotFilename,
      );

      if (numDiffPixels > 0 && researchOutputId) {
        nonMatchingResearchOutputIds.push(researchOutputId);
      } else {
        for (const file of [
          prEnvScreenshotFilename,
          prodScreenshotFilename,
          diffScreenshotFilename,
        ]) {
          fs.unlink(file, (err) => {
            if (err) {
              console.log(
                'Error deleting screenshot from a matching research output',
                err,
              );
            }
          });
        }
      }

      console.log(`Number of different pixels: ${numDiffPixels}`);
    }
    await browser.close();
  } catch (error) {
    console.error('Error:', error);
  }
  console.log(
    'Number of non matching research outputs',
    nonMatchingResearchOutputIds.length,
  );
  console.log('nonMatchingResearchOutputIds', nonMatchingResearchOutputIds);

  fs.writeFile(
    'nonMatchingResearchOutputIds.json',
    JSON.stringify(nonMatchingResearchOutputIds),
    (err) => {
      if (err)
        console.log('Error creating nonMatchingResearchOutputIds.json', err);
    },
  );
})();
