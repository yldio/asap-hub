version: '2.1'
services:
  localstack:
    image: localstack/localstack
    ports:
      - '4566-4584:4566-4584'
      - '8081:8080'
    environment:
      - SERVICES=ses
    volumes:
      - ./dev/localstack:/tmp/localstack

  mongo:
    image: mongo:latest
    ports:
      - '27017:27017'
    volumes:
      - ./dev/mongodb:/data/db
    restart: unless-stopped

  squidex:
    image: 'squidex/squidex:latest'
    ports:
      - '${SQUIDEX_PORT}:80'
    environment:
      - URLS__BASEURL=${SQUIDEX_URL}
      - URLS__ENFORCEHTTPS=${SQUIDEX_FORCE_HTTPS}
      - EVENTSTORE__MONGODB__CONFIGURATION=mongodb://mongo
      - STORE__MONGODB__CONFIGURATION=mongodb://mongo
      - IDENTITY__ADMINEMAIL=${SQUIDEX_ADMINEMAIL}
      - IDENTITY__ADMINPASSWORD=${SQUIDEX_ADMINPASSWORD}
    depends_on:
      - mongo
    volumes:
      - ./dev/squidex/assets:/app/Assets
    restart: unless-stopped

  setup_cms:
    build: .
    volumes:
      - ./dev/fixtures:/dev/fixtures
    depends_on:
      - mongo
      - squidex
    command: ./wait-for-it.sh squidex:80 -- ./setup-cms.sh
