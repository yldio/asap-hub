import { getLinkEntity } from '@asap-hub/contentful';
import { teamsQuery } from './teams.queries';
import {
  FetchTeamsQuery,
  FetchTeamsQueryVariables,
} from '../autogenerated-gql/graphql';
import { getSquidexAndContentfulClients, logger } from '../utils';
import { migrateFromSquidexToContentfulFactory } from '../utils/migration';

type TeamItem = NonNullable<FetchTeamsQuery['queryTeamsContents']>[number];

export const migrateTeamProposals = async () => {
  const { contentfulEnvironment, squidexGraphqlClient } =
    await getSquidexAndContentfulClients();

  const migrateFromSquidexToContentful = migrateFromSquidexToContentfulFactory(
    contentfulEnvironment,
    logger,
  );

  const fetchData = async () => {
    const gqlTeams = await squidexGraphqlClient.request<
      FetchTeamsQuery,
      FetchTeamsQueryVariables
    >(teamsQuery);
    return gqlTeams.queryTeamsContents || [];
  };

  const parseTeamItem = async (team: TeamItem) => {
    const { flatData: squidexTeamItem, id } = team;

    const teamPayload = {
      proposal: squidexTeamItem.proposal?.[0]
        ? getLinkEntity(squidexTeamItem.proposal[0].id)
        : null,
    };

    return { id, updateEntry: true, ...teamPayload };
  };

  await migrateFromSquidexToContentful<TeamItem>(
    'teams',
    fetchData,
    parseTeamItem,
    false, // clearPreviousEntries
  );
};
