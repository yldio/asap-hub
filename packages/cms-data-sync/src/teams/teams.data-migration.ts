import { teamsQuery } from './teams.queries';
import {
  FetchTeamsQuery,
  FetchTeamsQueryVariables,
} from '../autogenerated-gql/graphql';
import {
  clearContentfulEntries,
  getSquidexAndContentfulClients,
  logger,
} from '../utils';
import { migrateFromSquidexToContentfulFactory } from '../utils/migration';
import { createExternalToolLinks } from '../utils/externalTools';

type TeamItem = NonNullable<FetchTeamsQuery['queryTeamsContents']>[number];

export const migrateTeams = async () => {
  const { contentfulEnvironment, squidexGraphqlClient } =
    await getSquidexAndContentfulClients();

  await clearContentfulEntries(contentfulEnvironment, 'externalTools');

  const migrateFromSquidexToContentful = migrateFromSquidexToContentfulFactory(
    contentfulEnvironment,
    logger,
  );

  const fetchData = async () => {
    const gqlTeams = await squidexGraphqlClient.request<
      FetchTeamsQuery,
      FetchTeamsQueryVariables
    >(teamsQuery);

    return gqlTeams.queryTeamsContents || [];
  };

  const parseTeamItem = async (team: TeamItem) => {
    const { flatData: squidexTeamItem, id } = team;

    const {
      applicationNumber,
      displayName,
      expertiseAndResourceTags,
      inactiveSince,
      projectSummary,
      projectTitle,
      tools,
    } = squidexTeamItem;

    const teamPayload = {
      applicationNumber,
      displayName,
      expertiseAndResourceTags,
      inactiveSince,
      projectSummary,
      projectTitle,
      tools: tools
        ? await createExternalToolLinks(contentfulEnvironment, tools)
        : [],
    };

    return { id, ...teamPayload };
  };

  await migrateFromSquidexToContentful<TeamItem>(
    'teams',
    fetchData,
    parseTeamItem,
  );
};
