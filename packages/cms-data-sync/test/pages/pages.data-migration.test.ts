import { SquidexGraphqlClient } from '@asap-hub/squidex';
import { Entry, Environment } from 'contentful-management';
import { getSquidexAndContentfulClients } from '../../src/utils/setup';
import { getContentfulEnvironmentMock } from '../mocks/contentful.mocks';
import { migratePages } from '../../src/pages/pages.data-migration';
import { FetchPagesQuery } from '../../src/autogenerated-gql/graphql';
import { convertHtmlToContentfulFormat } from '../../src/utils/rich-text';

jest.mock('../../src/utils/setup');
jest.mock('../../src/utils/rich-text');

describe('Migrate Pages', () => {
  const squidexGraphqlClientMock: jest.Mocked<SquidexGraphqlClient> = {
    request: jest.fn(),
  };
  const contentfulEnv: jest.Mocked<Environment> =
    getContentfulEnvironmentMock();
  const entry = {
    sys: {
      id: 'entry-id',
    },
  } as unknown as Entry;

  (convertHtmlToContentfulFormat as jest.Mock).mockReturnValue({
    document: {
      content: [
        {
          content: [
            {
              data: {},
              marks: [],
              value: 'Hello world',
              nodeType: 'text',
            },
          ],
          data: {},
          nodeType: 'paragraph',
        },
      ],
      data: {},
      nodeType: 'document',
    },
    inlineAssetBodies: [],
  });

  const consoleLogRef = console.log;

  beforeEach(() => {
    console.log = jest.fn();

    (getSquidexAndContentfulClients as jest.Mock).mockResolvedValueOnce({
      contentfulEnvironment: contentfulEnv,
      squidexGraphqlClient: squidexGraphqlClientMock,
    });

    contentfulEnv.getEntries.mockResolvedValueOnce({
      total: 0,
      items: [],
      skip: 0,
      limit: 10,
      toPlainObject: jest.fn(),
      sys: { type: 'Array' },
    });
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  afterAll(() => {
    console.log = consoleLogRef;
  });

  test('Should fetch data from Squidex GraphQl API, parse it and create a record', async () => {
    squidexGraphqlClientMock.request.mockResolvedValueOnce(
      pagesSquidexGraphqlResponse,
    );
    contentfulEnv.createEntryWithId.mockResolvedValueOnce(entry);

    await migratePages();

    expect(contentfulEnv.createEntryWithId).toHaveBeenCalledWith(
      'pages',
      'page-id-1',
      {
        fields: {
          title: { 'en-US': 'Page 1' },
          text: {
            'en-US': {
              content: [
                {
                  content: [
                    {
                      data: {},
                      marks: [],
                      value: 'Hello world',
                      nodeType: 'text',
                    },
                  ],
                  data: {},
                  nodeType: 'paragraph',
                },
              ],
              data: {},
              nodeType: 'document',
            },
          },
          link: { 'en-US': 'https://www.example.com/page1' },
          linkText: { 'en-US': 'Page 1 link text' },
          path: { 'en-US': '/page1' },
          shortText: { 'en-US': 'Page 1 short text' },
        },
      },
    );
  });

  test('Should attempt to create a record without the text if it fails to create with the first attempt', async () => {
    squidexGraphqlClientMock.request.mockResolvedValueOnce(
      pagesSquidexGraphqlResponse,
    );
    contentfulEnv.createEntryWithId.mockRejectedValueOnce(new Error('Error'));
    contentfulEnv.createEntryWithId.mockResolvedValueOnce(entry);

    await migratePages();

    expect(contentfulEnv.createEntryWithId).toHaveBeenCalledWith(
      'pages',
      'page-id-1',
      {
        fields: {
          title: { 'en-US': 'Page 1' },
          text: { 'en-US': null },
          link: { 'en-US': 'https://www.example.com/page1' },
          linkText: { 'en-US': 'Page 1 link text' },
          path: { 'en-US': '/page1' },
          shortText: { 'en-US': 'Page 1 short text' },
        },
      },
    );
  });

  test('Should create a record without text field if it fails to parse the html to contentful ast', async () => {
    squidexGraphqlClientMock.request.mockResolvedValueOnce(
      pagesSquidexGraphqlResponse,
    );
    (convertHtmlToContentfulFormat as jest.Mock).mockImplementationOnce(() => {
      throw new Error();
    });
    contentfulEnv.createEntryWithId.mockResolvedValueOnce(entry);

    await migratePages();

    expect(contentfulEnv.createEntryWithId).toHaveBeenCalledWith(
      'pages',
      'page-id-1',
      {
        fields: expect.objectContaining({
          text: { 'en-US': null },
        }),
      },
    );
  });
});

const pagesSquidexGraphqlResponse: FetchPagesQuery = {
  queryPagesContents: [
    {
      id: 'page-id-1',
      flatData: {
        title: 'Page 1',
        text: '<p>Hello world</p>',
        link: 'https://www.example.com/page1',
        linkText: 'Page 1 link text',
        path: '/page1',
        shortText: 'Page 1 short text',
      },
    },
  ],
};
